{"version":3,"sources":["controls/securityTrimmedControl/SecurityTrimmedControl.tsx"],"names":[],"mappings":"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","file":"controls/securityTrimmedControl/SecurityTrimmedControl.js","sourcesContent":["import * as React from 'react';\nimport { ISecurityTrimmedControlProps, ISecurityTrimmedControlState, PermissionLevel } from '.';\nimport { SPHttpClient } from '@microsoft/sp-http';\nimport { SPPermission } from '@microsoft/sp-page-context';\nimport * as telemetry from '../../common/telemetry';\nimport { Spinner } from 'office-ui-fabric-react/lib/Spinner';\n\nexport class SecurityTrimmedControl extends React.Component<ISecurityTrimmedControlProps, ISecurityTrimmedControlState> {\n  constructor(props: ISecurityTrimmedControlProps) {\n    super(props);\n\n    this.state = {\n      allowRender: false,\n      loading: true\n    };\n\n    telemetry.track('SecurityTrimmedControl', {});\n  }\n\n  /**\n   * componentDidMount lifecycle method\n   */\n  public componentDidMount(): void {\n    this.checkPermissions();\n  }\n\n  /**\n   * componentDidUpdate lifecycle method\n   */\n  public componentDidUpdate(prevProps: ISecurityTrimmedControlProps, prevState: ISecurityTrimmedControlState): void {\n    // Check permissions only if necessary\n    if (prevProps.level !== this.props.level ||\n      prevProps.permissions !== this.props.permissions ||\n      prevProps.relativeLibOrListUrl !== this.props.relativeLibOrListUrl ||\n      prevProps.remoteSiteUrl !== this.props.remoteSiteUrl ||\n      prevProps.folderPath !== this.props.folderPath ||\n      prevProps.itemId !== this.props.itemId) {\n      this.checkPermissions();\n    }\n  }\n\n  /**\n   * Check if the user has the permissions to render the element\n   */\n  private checkPermissions() {\n    const { context, level } = this.props;\n    // Check if the permission level needs to be checked on the current site\n    if (level === PermissionLevel.currentWeb || level === PermissionLevel.currentList) {\n      // Get the permission scope\n      const { permissions } = level === PermissionLevel.currentWeb ? context.pageContext.web : context.pageContext.list;\n      // Check the user its permissions\n      if (permissions.hasAllPermissions(...this.props.permissions)) {\n        this.setState({\n          allowRender: true,\n          loading: false\n        });\n      } else {\n        this.setState({\n          allowRender: false,\n          loading: false\n        });\n      }\n    } else if (level === PermissionLevel.remoteWeb) {\n      // Check permissions on remote site\n      this.checkRemoteSitePermissions();\n    } else if (level === PermissionLevel.remoteListOrLib) {\n      // Check permissions on remote list/library\n      this.checkRemoteListOrLibPermissions();\n    } else if (level === PermissionLevel.remoteListItem) {\n      this.checkRemoteListItem();\n    } else if (level === PermissionLevel.remoteFolder) {\n      this.checkRemoteFolder();\n    }\n  }\n\n  /**\n   * Check the user its permissions on the remote site\n   */\n  private async checkRemoteSitePermissions() {\n    const { context, remoteSiteUrl, permissions } = this.props;\n    if (remoteSiteUrl && permissions) {\n      for (const permission of permissions) {\n        const apiUrl = `${remoteSiteUrl}/_api/web/DoesUserHavePermissions(@v)?@v=${JSON.stringify(permission.value)}`;\n        const result = await context.spHttpClient.get(apiUrl, SPHttpClient.configurations.v1).then(data => data.json());\n        // Check if a result was retrieved\n        if (result) {\n          // Check if an error was retrieved\n          if (result.error) {\n            // Do not allow rendering when there was an error\n            this.setState({\n              allowRender: false,\n              loading: false\n            });\n            console.error(`Error retrieved while checking user's remote site permissions.`);\n            return;\n          }\n          // Check the result value\n          if (typeof result.value !== \"undefined\" && result.value === false) {\n            this.setState({\n              allowRender: false,\n              loading: false\n            });\n            return;\n          }\n        } else {\n          this.setState({\n            allowRender: false,\n            loading: false\n          });\n          console.error(`No result value was retrieved when checking the user's remote site permissions.`);\n          return;\n        }\n      }\n\n      // Render the controls when the permissions were OK for the user\n      this.setState({\n        allowRender: true,\n        loading: false\n      });\n    }\n  }\n\n  /**\n   * Check the user its permissions on the remote list or library\n   */\n  private async checkRemoteListOrLibPermissions() {\n    const { remoteSiteUrl, relativeLibOrListUrl, permissions } = this.props;\n    // Check if all properties are provided\n    if (remoteSiteUrl && relativeLibOrListUrl && permissions) {\n      const apiUrl = `${remoteSiteUrl}/_api/web/GetList(@listUrl)/EffectiveBasePermissions?@listUrl='${encodeURIComponent(relativeLibOrListUrl)}'`;\n      const hasPermissions = await this.checkRemotePermissions(apiUrl);\n      this.setState({\n        allowRender: hasPermissions,\n        loading: false\n      });\n    }\n  }\n\n  /**\n   * Check permissions on item level\n   */\n  private async checkRemoteListItem() {\n    const { remoteSiteUrl, relativeLibOrListUrl, permissions, itemId } = this.props;\n    // Check if all properties are provided\n    if (remoteSiteUrl && relativeLibOrListUrl && permissions && itemId) {\n      const apiUrl = `${remoteSiteUrl}/_api/web/GetList(@listUrl)/Items(${itemId})/EffectiveBasePermissions?@listUrl='${encodeURIComponent(relativeLibOrListUrl)}'`;\n      const hasPermissions = await this.checkRemotePermissions(apiUrl);\n      this.setState({\n        allowRender: hasPermissions,\n        loading: false\n      });\n    }\n  }\n\n  /**\n   * Check permissions on folder\n   */\n  private async checkRemoteFolder() {\n    const { remoteSiteUrl, relativeLibOrListUrl, permissions, folderPath } = this.props;\n    // Check if all properties are provided\n    if (remoteSiteUrl && relativeLibOrListUrl && permissions && folderPath) {\n      const folderByServerRelativeUrl: string = `${encodeURIComponent(relativeLibOrListUrl)}/${encodeURIComponent(folderPath)}`;\n      const apiUrl = `${remoteSiteUrl}/_api/web/GetFolderByServerRelativeUrl(@folderByServerRelativeUrl)/ListItemAllFields/EffectiveBasePermissions?@folderByServerRelativeUrl='${folderByServerRelativeUrl}'`;\n      const hasPermissions = await this.checkRemotePermissions(apiUrl);\n      this.setState({\n        allowRender: hasPermissions,\n        loading: false\n      });\n    }\n  }\n\n  /**\n   * Check the permissions\n   *\n   * @param apiUrl\n   */\n  private async checkRemotePermissions(apiUrl: string) {\n    const { context, permissions } = this.props;\n    const data = await context.spHttpClient.get(apiUrl, SPHttpClient.configurations.v1);\n    // Check if a result was retrieved\n    if (data && data.ok) {\n      const result = await data.json();\n      // Check if an error was retrieved\n      if (result.error) {\n        // Do not allow rendering when there was an error\n        console.error(`Error retrieved while checking permissions`);\n        return false;\n      }\n\n      // Check the result high and low value are returned\n      if (typeof result.High !== \"undefined\" && typeof result.Low !== \"undefined\") {\n        // Create the permission mask\n        const permission = new SPPermission(result);\n        const hasPermissions = permission.hasAllPermissions(...permissions);\n        return hasPermissions;\n      }\n    } else {\n      console.error(`No result value was retrieved when checking the user's permissions.`);\n      return false;\n    }\n  }\n\n  /**\n   * Default React render method\n   */\n  public render(): React.ReactElement<ISecurityTrimmedControlProps> {\n    const { className } = this.props;\n    if(this.state.loading && this.props.showLoadingAnimation){\n      return <Spinner />;\n    }\n    if(this.state.allowRender){\n      return <div className={className ? className : \"\"}>{this.props.children}</div>;\n    }\n    else if(this.props.noPermissionsControl){\n      return this.props.noPermissionsControl;\n    }\n    return null;\n  }\n}\n"],"sourceRoot":"../../../src"}